---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { generateArticleSchema, SITE_CONFIG } from '../../utils/seo';
import { experts } from '../../data/experts';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Trouver l'expert correspondant
const author = experts.find(e => e.id === post.data.author.id) || experts[0];

// Générer le schema article
const articleSchema = generateArticleSchema({
  title: post.data.title,
  description: post.data.description,
  url: `${SITE_CONFIG.url}/blog/${post.slug}`,
  image: `${SITE_CONFIG.url}${post.data.image.src}`,
  publishedDate: post.data.publishedDate,
  modifiedDate: post.data.modifiedDate,
  author: {
    name: author.name,
    url: `${SITE_CONFIG.url}/experts/${author.id}`,
  },
});

const categoryColors: Record<string, string> = {
  solaire: 'bg-solar-100 text-solar-800',
  stockage: 'bg-primary-100 text-primary-800',
  'mobilite-electrique': 'bg-electric-100 text-electric-800',
  eolien: 'bg-teal-100 text-teal-800',
  'aides-financieres': 'bg-purple-100 text-purple-800',
  conseils: 'bg-dark-100 text-dark-800',
};
---

<Layout
  title={post.data.title}
  description={post.data.description}
  ogType="article"
  ogImage={post.data.image.src}
  publishedDate={post.data.publishedDate}
  modifiedDate={post.data.modifiedDate}
  author={author.name}
  keywords={post.data.tags}
  schema={articleSchema}
>
  <article class="section">
    <div class="container-custom">
      <!-- Breadcrumb -->
      <nav class="mb-8" aria-label="Fil d'Ariane">
        <ol class="flex items-center gap-2 text-sm text-dark-500">
          <li>
            <a href="/" class="hover:text-primary-600 transition-colors">Accueil</a>
          </li>
          <li><span class="mx-2">/</span></li>
          <li>
            <a href="/blog" class="hover:text-primary-600 transition-colors">Blog</a>
          </li>
          <li><span class="mx-2">/</span></li>
          <li class="text-dark-700 font-medium truncate max-w-[200px]">
            {post.data.title}
          </li>
        </ol>
      </nav>
      
      <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-12">
          <!-- Category & Reading time -->
          <div class="flex items-center gap-3 mb-4">
            <span class={`badge ${categoryColors[post.data.category] || 'bg-dark-100 text-dark-800'}`}>
              {post.data.category.replace('-', ' ')}
            </span>
            <span class="text-sm text-dark-400">
              ⏱️ {post.data.readingTime} min de lecture
            </span>
          </div>
          
          <!-- Title -->
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-dark-900 mb-6 leading-tight">
            {post.data.title}
          </h1>
          
          <!-- Description -->
          <p class="text-xl text-dark-600 mb-8">
            {post.data.description}
          </p>
          
          <!-- Author & Date -->
          <div class="flex flex-wrap items-center gap-6 pb-8 border-b border-dark-200">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary-100 to-primary-200 flex items-center justify-center">
                <span class="text-lg font-bold text-primary-600">
                  {author.name.charAt(0)}
                </span>
              </div>
              <div>
                <p class="font-semibold text-dark-900">{author.name}</p>
                <p class="text-sm text-dark-500">{author.role}</p>
              </div>
            </div>
            
            <div class="flex items-center gap-4 text-sm text-dark-500">
              <time datetime={post.data.publishedDate}>
                Publié le {new Date(post.data.publishedDate).toLocaleDateString('fr-FR', {
                  day: 'numeric',
                  month: 'long',
                  year: 'numeric'
                })}
              </time>
              {post.data.modifiedDate && (
                <span>
                  • Mis à jour le {new Date(post.data.modifiedDate).toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                  })}
                </span>
              )}
            </div>
          </div>
        </header>
        
        <!-- Featured Image placeholder -->
        <div class="aspect-video bg-gradient-to-br from-primary-100 via-solar-50 to-electric-100 rounded-2xl mb-12 flex items-center justify-center">
          <svg class="w-24 h-24 text-primary-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
          </svg>
        </div>
        
        <!-- Content -->
        <div class="prose-custom">
          <Content />
        </div>
        
        <!-- Tags -->
        <div class="mt-12 pt-8 border-t border-dark-200">
          <p class="text-sm text-dark-500 mb-3">Tags :</p>
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map((tag: string) => (
              <span class="px-3 py-1 bg-dark-100 text-dark-700 rounded-lg text-sm">
                #{tag}
              </span>
            ))}
          </div>
        </div>
        
        <!-- Author Bio -->
        <div class="mt-12 p-6 bg-primary-50 rounded-2xl">
          <div class="flex flex-col sm:flex-row gap-6">
            <div class="flex-shrink-0">
              <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-primary-200 to-primary-300 flex items-center justify-center">
                <span class="text-2xl font-bold text-primary-700">
                  {author.name.charAt(0)}
                </span>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-bold text-dark-900 mb-1">
                À propos de {author.name}
              </h3>
              <p class="text-primary-700 text-sm font-medium mb-3">
                {author.role} • {author.experience}
              </p>
              <p class="text-dark-600 text-sm leading-relaxed">
                {author.bio}
              </p>
              <div class="mt-3 flex flex-wrap gap-2">
                {author.certifications.slice(0, 2).map((cert) => (
                  <span class="inline-flex items-center gap-1 px-2 py-1 bg-white text-primary-700 rounded text-xs font-medium">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    {cert}
                  </span>
                ))}
              </div>
            </div>
          </div>
        </div>
        
        <!-- CTA -->
        <div class="mt-12 text-center p-8 bg-gradient-to-br from-dark-900 to-dark-800 rounded-2xl">
          <h3 class="text-2xl font-bold text-white mb-3">
            Prêt à concrétiser votre projet ?
          </h3>
          <p class="text-dark-300 mb-6">
            Obtenez une simulation personnalisée gratuite en 30 secondes
          </p>
          <a href="/#simulateur" class="btn bg-white text-primary-700 hover:bg-primary-50 btn-lg">
            Calculer mes économies
          </a>
        </div>
      </div>
    </div>
  </article>
</Layout>
